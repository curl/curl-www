reuse of wrong HTTP NTLM connection
===================================

Project curl Security Advisory, January 29th 2014
[Permalink](https://curl.se/docs/CVE-2014-0015.html)

VULNERABILITY
-------------

libcurl can in some circumstances reuse the wrong connection when asked to
do an NTLM-authenticated HTTP or HTTPS request.

libcurl features a pool of recent connections so that subsequent requests
can reuse an existing connection to avoid overhead.

When reusing a connection a range of criterion must first be met. Due to a
logical error in the code, a request that was issued by an application could
wrongfully reuse an existing connection to the same server that was
authenticated using different credentials. One underlying reason being that
NTLM authenticates connections and not requests, contrary to how HTTP is
designed to work and how other authentication methods work.

An application that allows NTLM and another auth method (the bug only triggers
if more than one auth method is asked for) to a server (that responds wanting
NTLM) with user1:password1 and then does another operation to the same server
with user2:password2 (when the previous connection was left alive) - the
second request reuses the same connection and since it then sees that the
NTLM negotiation is already made, it just sends the request over that
connection thinking it uses the user2 credentials when it is in fact still
using the connection authenticated for user1...

The set of auth methods to use is set with `CURLOPT_HTTPAUTH`.

Two common auth defines in libcurl are `CURLAUTH_ANY` and `CURLAUTH_ANYSAFE`.
Both of them ask for NTLM and other methods and can therefore trigger this
problem.

Applications can disable libcurl's reuse of connections and thus mitigate
this problem, by using one of the following libcurl options to alter how
connections are or are not reused: `CURLOPT_FRESH_CONNECT`,
`CURLOPT_MAXCONNECTS` and `CURLMOPT_MAX_HOST_CONNECTIONS` (if using the
curl_multi API).

INFO
----

The Common Vulnerabilities and Exposures (CVE) project has assigned the name
CVE-2014-0015 to this issue.

CWE-305: Authentication Bypass by Primary Weakness

Severity: Medium

AFFECTED VERSIONS
-----------------

This flaw has existed ever since libcurl started to support NTLM, although
the code has been restructured a few times over the years so the mistake has
altered shape over the years.

- Affected versions: from libcurl 7.10.6 to and including 7.34.0
- Not affected versions: libcurl < 7.10.6 and >= 7.35.0
- Introduced-in: https://github.com/curl/curl/commit/73c5f24fa40460f41d6

libcurl is used by many applications, but not always advertised as such!

SOLUTION
--------

libcurl 7.35.0 makes sure that connections that may use NTLM cannot reuse
another NTLM-using connection unless the credentials match.

- Fixed-in: https://github.com/curl/curl/commit/8ae35102c43d8d

This fix is already committed to the public source code repository because the
full security impact was not properly realized until after the fact.

RECOMMENDATIONS
---------------

We suggest you take one of the following actions immediately, in order of
preference:

 A - Upgrade to curl and libcurl 7.35.0

 B - Apply the patch and rebuild libcurl

 C - Avoid using HTTP NTLM in your application, or make sure to *only*
     specify NTLM as the requested authentication method.

TIMELINE
---------

It was reported to the curl project on January 7th 2014. We contacted
distros@openwall on January 14th.

libcurl 7.35.0 was released on January 29th 2014, coordinated with the
publication of this advisory.

CREDITS
-------

- Reported-by: Paras Sethia
- Patched-by: Daniel Stenberg
- Help-by: Yehezkel Horowitz

Thanks a lot!
