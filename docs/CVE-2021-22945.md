UAF and double free in MQTT sending
===================================

Project curl Security Advisory, September 15th 2021 -
[Permalink](https://curl.se/docs/CVE-2021-22945.html)

VULNERABILITY
-------------

When sending data to an MQTT server, libcurl could in some circumstances
erroneously keep a pointer to an already freed memory area and both use that
again in a subsequent call to send data and also free it *again*.

INFO
----

This flaw was introduced in commit
[2522903b79](https://github.com/curl/curl/commit/2522903b79) but since MQTT
support was marked 'experimental' then and not enabled in the build by default
until curl 7.73.0 (October 14, 2020) we count that as the first flawed
version.

The fixed libcurl version properly clears the pointer when the data has been
sent.

The Common Vulnerabilities and Exposures (CVE) project has assigned the name
CVE-2021-22945 to this issue.

CWE-415: Double Free

Severity: Medium

AFFECTED VERSIONS
-----------------

- Affected versions: curl 7.73.0 to and including 7.78.0
- Not affected versions: curl < 7.73.0 and curl >= 7.79.0
- Introduced-in: https://github.com/curl/curl/commit/2522903b79

Also note that libcurl is used by many applications, and not always advertised
as such.

SOLUTION
------------

- Fixed-in: https://github.com/curl/curl/commit/43157490a5054bd

RECOMMENDATIONS
--------------

 A - Upgrade curl to version 7.79.0

 B - Apply the patch to your local version

 C - Do not use MQTT

TIMELINE
--------

This issue was reported to the curl project on July 19, 2021.

This advisory was posted on September 15, 2021.

CREDITS
-------

- Reported-by: z2_
- Patched-by: z2_

Thanks a lot!
